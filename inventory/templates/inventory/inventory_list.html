{% extends 'inventory/base_side.html' %}

{% load humanize %}

{% block content %}
<main role="main" class="container">
  <!--Modal for selecting reduction qty-->
    <div class="row m-4">
      <!--No Move List-->
      <div class="col-sm-10">
        <div hidden id="debug" data-id={{ DEBUG }}></div>
        <h1 class="mt-4 ml-2">Target High Ext Items <i class="fas fa-money-bill"></i></h1>
        <p class="ml-4">Top 100 highest extended cost items, pulled from your OR/Cath Lab inventory counts.</p>
      </div>
    </div>

    <!-- List of no intake items -->
    {% if count_usage_list %}
      <ul id="nomovelist">
          {% for item in count_usage_list %}
          <li
            style="list-style-type: none;"
            id={{ item.id }}
          >
            <div class="card shadow mt-3">
              <div class="card-body">
                <h5 class="card-title">{{ item.description }}</h5>

                <div class="row">
                  <div class="col-sm">
                    <h6 class="card-subtitle mb-2 text-muted">
                      IMMS #: {{ item.imms }}
                    </h6>
                  </div>
                  <div class="col-sm">
                    <p class="card-text">Qty: {{ item.count_qty|intcomma }}</p>
                  </div>
                  <div class="col-sm">
                    <p class="card-text">
                      Cost: ${{ item.luom_cost|floatformat:0|intcomma }}
                    </p>
                  </div>
                  <div class="col-sm">
                    <p class="card-text">
                      Ext: ${{ item.ext_cost|floatformat:0|intcomma }}
                    </p>
                  </div>
                </div>

                <div class="row">
                  <div class="col-sm">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" data-id={{ item.id }}>
                      <label class="ml-2" for="flexSwitchCheckDefault">Target Item</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </li>
          {% endfor %}
      </ul>
</main>

{% else %}

<h4 class="mt-5">
  Could not find items... This is a system error. Please screenshot and send this to jdprice@baptisthealthsystem.com.
</h4>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  const csrftoken = getCookie('csrftoken');

  $("input[type='checkbox']").change(function() {
    // If target item is checked...
    const selectedCheckbox = $(this).closest('input');
    const selectedId = $(this).attr('data-id');

    let host = '';
    const DEBUG = $("#debug").attr('data-id');

    if (DEBUG === "False") {
      host = 'https://reductiontoolkit.com';
    } else {
      host = 'http://127.0.0.1:8000';
    }

    if (selectedCheckbox.is(":checked")) {
      const urlTrue = `${host}/target/${selectedId}/settrue/`;
      $.ajax({
        url: urlTrue,
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        data: {'setIsTarget': true}
      })
      .done(function(response) {
        console.log(response);
      })
      .fail(function(error) {
        console.log(error);
      });

      // If target item is unchecked...
    } else {
      const urlFalse = `${host}/target/${selectedId}/setfalse/`;
      $.ajax({
        url: urlFalse,
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        data: {'setIsTarget': false}
      })
      .done(function(response) {
        console.log(response);
      })
      .fail(function(error) {
        console.log(error);
      });
    }
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
  }
</script>
{% endblock %} 