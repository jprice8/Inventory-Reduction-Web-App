{% extends 'inventory/base.html' %}

{% load humanize %}
{% load static %}

{% block content %}
<main role="main" class="container">
  <!--Modal for selecting reduction qty-->
  <div class="row m-4">
    <!--No Move List-->
    <div class="col-8">
      <h1 class="mt-4 ml-2">Review Target Items <i class="fas fa-clipboard-check"></i></h1>
      <p class="ml-4">Click on "Set Movement Plan" to continue or click the Target Item check to remove item from the list.</p>
    </div>
    <div class="col-sm">
      <a class="btn btn-primary mt-5" href="{% url 'count-usage-list' %}"><i class="fas fa-arrow-left"></i> Back to No Move List</a>
    </div>
  </div>
  {% if target_list %}
  <ul id="targetlist">
    {% for item in target_list %}
    <li
      style="list-style-type: none;"
      id={{ item.id }}
    >
      <div class="card shadow mt-3">
        <div class="card-body">
          <h5 class="card-title">{{ item.description }}</h5>
          <div class="row">
            <div class="col-sm">
              <p class="card-text">Mfr Cat No: {{ item.mfr_cat_no }}</p>
            </div>
            <div class="col-sm">
              <p class="card-text">IMMS #: {{ item.imms }}</p>
            </div>
            <div class="col-sm">
            </div>
          </div>

          <div class="row">
            <div class="col-sm">
              <p class="card-text">Quantity: {{ item.count_qty|intcomma }}</p>
            </div>
            <div class="col-sm">
              <p class="card-text">
                Cost: ${{ item.luom_cost|floatformat:0|intcomma }}
              </p>
            </div>
            <div class="col-sm">
              <p class="card-text">
                Ext: ${{ item.ext_cost|floatformat:0|intcomma }}
              </p>
            </div>
          </div>

          <div class="row">
            <div class="col-sm">
              <div class="form-check form-switch mt-3">
                <input class="form-check-input" checked type="checkbox" data-id={{ item.id }}>
                <label class="form-check-label ml-2" for="flexSwitchCheckDefault">Target Item</label>
              </div>
            </div>
            <div class="col-sm">
              {% if item.id in not_outstanding_ids %}
              <a class="btn btn-success mt-3" href="#">Set Movement Plan</a>
              {% elif item.id in outstanding_ids %}
              <a class="btn btn-warning mt-3" href="#">Set Movement Plan</a>
              {% else %}
              <a class="btn btn-danger mt-3" href="{% url 'move-targets' item.id %}">Set Movement Plan</a>
              {% endif %}
            </div>
            <div class="col-sm mt-2">
              {% for plan in all_plans %}
                {% if item.id == plan.item_id %}
                  {% if plan.result == 'accepted' %}
                  <p>Current Status: <mark>{{ plan.result }}</mark><br> Quantity approved: <mark>{{ plan.accepted_qty }}</mark></p>
                  {% else %}
                  <p>Current Status: <mark>{{ plan.result }}</mark></p>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </li>
    {% endfor %}
  </ul>
</main>

{% else %}
  <h4 class="mt-5">
    No items targeted yet. Go back to the no move list and start identifying items for reduction!
  </h4>
{% endif %} 
{% endblock %}

{% block extra_js %}
<script>
  const csrftoken = getCookie('csrftoken');

  $("input[type='checkbox']").change(function() {
    // If target item is checked...
    const selectedCheckbox = $(this).closest('input');
    const selectedId = $(this).attr('data-id');

    if (selectedCheckbox.is(":checked")) {
      const urlTrue = `https://reductiontoolkit.com/target/${selectedId}/settrue/`;
      $.ajax({
        url: urlTrue,
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        data: {'setIsTarget': true}
      })
      .done(function(response) {
        console.log(response);
      })
      .fail(function(error) {
        console.log(error);
      });

      // If target item is unchecked...
    } else {
      const urlFalse = `https://reductiontoolkit.com/target/${selectedId}/setfalse/`;
      $.ajax({
        url: urlFalse,
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        data: {'setIsTarget': false}
      })
      .done(function(response) {
        console.log(response);
      })
      .fail(function(error) {
        console.log(error);
      });
    }
  });

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
  }
</script>
{% endblock %}